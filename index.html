<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>堅果量計算工具</title>
    <!-- 引入Tailwind CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      /* 使用莫蘭迪色系 */
      body {
        background-color: #edeae0;
        color: #4d4d4d;
      }

      .subtotal-container,
      .result-container {
        border: 1px solid #d3cec4;
        border-radius: 8px;
        background-color: #f0eee9;
      }

      ul#cart-list {
        list-style-type: none;
        padding: 0;
      }

      ul#cart-list li {
        margin-bottom: 8px;
        padding: 8px;
        background-color: #d3cec4;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      ul#cart-list li .delete-button {
        background-color: #a16e5a;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        margin-left: auto;
        order: 2;
      }

      ul#cart-list li .delete-button:hover {
        background-color: #8c5b4a;
      }

      ul#cart-list li .cost-info {
        margin-top: 8px;
        order: 1;
        width: 100%;
      }

      /* 調整第三欄的排版 */
      .result-container ul {
        padding-left: 20px;
        margin-bottom: 20px;
      }

      .result-container ul li {
        margin-bottom: 8px;
        font-size: 16px;
        line-height: 1.5;
      }

      .result-container p {
        font-size: 18px;
        line-height: 1.5;
        margin-bottom: 12px;
        font-weight: bold;
      }

      .btn-reset {
        background-color: #8c7b75;
      }

      .btn-reset:hover {
        background-color: #77655e;
      }

      .btn-add {
        background-color: #a16e5a;
      }

      .btn-add:hover {
        background-color: #8c5b4a;
      }

      .btn-calculate {
        background-color: #a7a89e;
      }

      .btn-calculate:hover {
        background-color: #8e8f85;
      }

      .btn-export {
        background-color: #7a8c99;
      }

      .btn-export:hover {
        background-color: #667a85;
      }

      /* 自定義彈窗 */
      .custom-alert-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        display: none;
      }

      .custom-alert {
        background-color: #f0eee9;
        border: 1px solid #d3cec4;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);
        max-height: 95vh;
        overflow-y: auto;
        width: 95%;
        max-width: 1200px;
        position: relative;
      }

      .custom-alert .close-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: transparent;
        border: none;
        font-size: 22px;
        cursor: pointer;
        color: #4d4d4d;
      }

      iframe.chart-frame {
        width: 100%;
        height: 90vh;
        border: none;
        border-radius: 10px;
        overflow: hidden;
      }

      /* 自定義 Radio 按鈕樣式 */
      .custom-radio-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        border: 2px solid #d3cec4; /* 淺灰色邊框 */
        background-color: #f0eee9; /* 莫蘭迪底色 */
        color: #4d4d4d; /* 文字顏色 */
        transition: background-color 0.3s, border-color 0.3s, color 0.3s;
      }

      .custom-radio-label:hover {
        background-color: #d3cec4; /* 滑過時變深 */
      }

      .custom-radio:checked + .custom-radio-label {
        background-color: #a16e5a; /* 選中後背景變為莫蘭迪褐色 */
        border-color: #a16e5a; /* 邊框顏色匹配背景 */
        color: #fff; /* 文字變白色 */
      }

      /* 隱藏原生 Radio 按鈕 */
      .custom-radio {
        display: none;
      }
    </style>
  </head>
  <body class="p-6">
    <div class="container mx-auto">
      <div class="flex flex-wrap justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">堅果量計算工具</h1>
        <div
          class="grid grid-cols-2 sm:flex gap-4 mt-4 md:mt-0 w-full sm:w-auto"
        >
          <button
            id="view-ratio-btn"
            class="text-white font-bold py-2 px-4 rounded btn-add"
            onclick="showNutRatios()"
          >
            產品組合
          </button>
          <button
            id="nut-cost-btn"
            class="text-white font-bold py-2 px-4 rounded btn-add"
            onclick="showNutCosts()"
          >
            價格比較
          </button>
          <a
            href="chart.html"
            class="text-white font-bold py-2 px-4 rounded btn-reset text-center"
          >
            圓餅圖
          </a>
          <a
            href="weight-table.html"
            class="text-white font-bold py-2 px-4 rounded btn-reset text-center"
          >
            克數比例
          </a>
          <a
            href="nuts-kg-cost.html"
            class="text-white font-bold py-2 px-4 rounded btn-reset text-center"
          >
            堅果KG成本
          </a>
          <a
            href="nutri-table.html"
            class="text-white font-bold py-2 px-4 rounded btn-reset text-center"
          >
            營養價值
          </a>
          <a
            href="files.html"
            class="text-white font-bold py-2 px-4 rounded btn-reset text-center"
          >
            相關檔案
          </a>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="package-weight" class="block text-lg font-semibold mb-2">
            每包克數:
          </label>
          <div
            id="weight-radio-container"
            class="mb-4 flex flex-wrap gap-2 items-center"
          ></div>

          <label for="package-count" class="block text-lg font-semibold mb-2"
            >生產包數:</label
          >
          <input
            type="number"
            id="package-count"
            class="w-full border rounded p-2 mb-4"
            value="1000"
          />

          <label for="combination" class="block text-lg font-semibold mb-2"
            >選擇組合:</label
          >
          <select
            id="combination"
            class="w-full border rounded p-2 mb-4"
          ></select>

          <label id="show-cost-label" class="block text-lg font-semibold mb-4">
            <input type="checkbox" id="show-cost" onchange="updateCart()" />
            顯示成本
          </label>

          <div class="flex gap-x-4">
            <button
              onclick="resetCart()"
              class="w-full text-white font-bold py-2 px-4 rounded mb-3 btn-reset"
            >
              重置小計
            </button>
            <button
              onclick="addToCart()"
              class="w-full text-white font-bold py-2 px-4 rounded mb-3 btn-add"
            >
              加入小計
            </button>
          </div>
        </div>

        <div class="subtotal-container p-4">
          <h3 class="text-xl font-bold mb-4">小計</h3>

          <div class="cart-items" id="cart-items">
            <ul id="cart-list" class="sortable"></ul>
          </div>

          <button
            onclick="saveCurrentCart()"
            class="w-full text-white font-bold py-2 px-4 rounded mb-4 btn-add"
          >
            儲存目前小計
          </button>
          <div id="saved-records" class="">
            <div class="flex justify-between items-center mb-2">
              <h4 class="text-lg font-bold">過往紀錄</h4>
              <button
                onclick="clearAllSavedRecords()"
                class="btn-reset text-white text-sm font-bold py-1 px-2 rounded"
              >
                清空全部
              </button>
            </div>
            <ul id="record-list" class="space-y-2"></ul>
          </div>
        </div>

        <div class="result-container p-4">
          <label for="extra-percent" class="block text-lg font-semibold mb-2">
            預估加成 (%):
          </label>
          <input
            type="number"
            id="extra-percent"
            class="w-full border rounded p-2 mb-4"
            value="0"
            min="0"
            max="100"
          />
          <button
            onclick="calculate()"
            class="w-full text-white font-bold py-2 px-4 rounded mb-3 btn-calculate"
          >
            計算總量
          </button>

          <h3 class="text-xl font-bold mb-4">總量計算</h3>
          <div class="result" id="result"></div>
          <button
            id="export-btn"
            onclick="exportToTxt()"
            class="w-full text-white font-bold py-2 px-4 rounded btn-export hidden"
          >
            匯出結果
          </button>
        </div>
      </div>
    </div>

    <!-- 自定義彈窗，嵌入 chart.html -->
    <div class="custom-alert-overlay" id="customAlert">
      <div class="custom-alert">
        <button class="close-button" onclick="closeCustomAlert()">X</button>
        <iframe src="chart.html" class="chart-frame"></iframe>
      </div>
    </div>

    <!-- 自定義彈窗，嵌入 cost-chart.html -->
    <div class="custom-alert-overlay" id="costAlert">
      <div class="custom-alert">
        <button class="close-button" onclick="closeCostAlert()">X</button>
        <iframe src="cost-chart.html" class="chart-frame"></iframe>
      </div>
    </div>

    <!-- 引入外部JavaScript文件 -->
    <script type="module" src="./lib/nuts-data.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script type="module">
      import {
        nutsData,
        totalPrices,
        printingPackagingCost,
      } from "./lib/nuts-data.js";

      const weights = [25, 42, 100, 600];

      document.addEventListener("DOMContentLoaded", () => {
        const container = document.querySelector("#weight-radio-container");

        weights.forEach((weight, idx) => {
          // 建立 radio 元素
          const input = document.createElement("input");
          input.type = "radio";
          input.id = `weight-${weight}`;
          input.name = "package-weight";
          input.value = weight;
          input.className = "hidden custom-radio";
          if (idx === 0) input.checked = true;

          // 建立 label 元素
          const label = document.createElement("label");
          label.htmlFor = `weight-${weight}`;
          label.className = "custom-radio-label";
          label.textContent = `${weight} 克`;

          // 插入至容器中
          container.appendChild(input);
          container.appendChild(label);
        });
        renderSavedRecords();
      });

      document.addEventListener("DOMContentLoaded", function () {
        const combinationSelect = document.getElementById("combination");
        // 清空現有選項
        combinationSelect.innerHTML = "";

        // 遍歷 nutsData 中的 key，並將它們作為選項填充至下拉選單中
        for (const key in nutsData) {
          if (nutsData.hasOwnProperty(key)) {
            const option = document.createElement("option");
            option.value = key;
            option.textContent = key;
            combinationSelect.appendChild(option);
          }
        }
      });

      // 初始化拖曳功能
      $(function () {
        $(".sortable").sortable({
          update: function () {
            // 取得排序後的新順序
            const newCart = [];
            $("#cart-list li").each(function () {
              const originalIndex = parseInt(this.dataset.index, 10);
              newCart.push(cart[originalIndex]);
            });
            cart = newCart;
            updateCart(); // 重新渲染一次以刷新 data-index
          },
        });
        $(".sortable").disableSelection();
      });

      let cart = [];
      let lastResult = {};

      // 將函數掛載到 window 對象上
      window.addToCart = function addToCart() {
        const weightPerPackage = parseFloat(
          document.querySelector('input[name="package-weight"]:checked').value
        );
        const packageCount = parseInt(
          document.getElementById("package-count").value
        );
        const combination = document.getElementById("combination").value;

        cart.push({ weightPerPackage, packageCount, combination });
        updateCart();
      };

      window.updateCart = function updateCart() {
        const cartList = document.getElementById("cart-list");
        const showCost = document.getElementById("show-cost").checked;
        cartList.innerHTML = "";

        cart.forEach((item, index) => {
          const nutPercentages = nutsData[item.combination];
          let nutDetails = "成份：";
          for (const nut in nutPercentages) {
            if (nutPercentages[nut] > 0) {
              nutDetails += `${nut}${nutPercentages[nut]}%、`;
            }
          }
          nutDetails = nutDetails.slice(0, -1); // 去掉最後逗號

          const listItem = document.createElement("li");
          listItem.dataset.index = index;

          const mainContent = document.createElement("div");
          mainContent.className = "flex-1";
          mainContent.innerHTML = `
      <span>${item.weightPerPackage}g ${item.combination} - ${item.packageCount} 包</span>
      <div class="cost-info">${nutDetails}</div>
    `;

          if (showCost) {
            const cost = calculateCost(
              item.combination,
              item.weightPerPackage,
              item.packageCount
            );
            const costInfo = document.createElement("div");
            costInfo.classList.add("cost-info");
            if (cost) {
              costInfo.textContent = `原料成本: $${cost.materialCost.toFixed(
                2
              )}, 印刷: $${cost.printing.toFixed(
                2
              )}, 包裝: $${cost.packaging.toFixed(
                2
              )}, 總每包: $${cost.totalPerPackage.toFixed(2)}`;
            } else {
              costInfo.textContent = `成本資料不完整`;
            }

            mainContent.appendChild(costInfo);
          }

          const buttonGroup = document.createElement("div");
          buttonGroup.className = "flex flex-col gap-1 ml-2";

          const upBtn = document.createElement("button");
          upBtn.textContent = "↑";
          upBtn.className = "btn-reset text-white px-2 py-1 text-sm rounded";
          upBtn.onclick = () => moveItem(index, -1);
          upBtn.disabled = index === 0;

          const downBtn = document.createElement("button");
          downBtn.textContent = "↓";
          downBtn.className = "btn-reset text-white px-2 py-1 text-sm rounded";
          downBtn.onclick = () => moveItem(index, 1);
          downBtn.disabled = index === cart.length - 1;

          const delBtn = document.createElement("button");
          delBtn.textContent = "刪除";
          delBtn.className = "delete-button text-sm";
          delBtn.onclick = () => removeFromCart(index);

          buttonGroup.appendChild(upBtn);
          buttonGroup.appendChild(downBtn);
          buttonGroup.appendChild(delBtn);

          listItem.appendChild(mainContent);
          listItem.appendChild(buttonGroup);
          cartList.appendChild(listItem);
        });
      };

      window.calculateCost = function calculateCost(
        combination,
        weightPerPackage,
        packageCount
      ) {
        const nutPercentages = nutsData[combination];
        let materialCost = 0;

        for (const nut in nutPercentages) {
          const percentage = nutPercentages[nut] / 100;
          const nutWeight = percentage * weightPerPackage;
          const unitPrice = totalPrices[nut] / 1000; // 單位為每克
          materialCost += nutWeight * unitPrice;
        }

        const costExtras = printingPackagingCost[weightPerPackage] || {
          printing: 0,
          packaging: 0,
        };

        const totalPerPackage =
          materialCost + costExtras.printing + costExtras.packaging;
        const totalCost = totalPerPackage * packageCount;

        return {
          materialCost,
          printing: costExtras.printing,
          packaging: costExtras.packaging,
          totalPerPackage,
          totalCost,
        };
      };

      window.removeFromCart = function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
      };

      window.resetCart = function resetCart() {
        cart = [];
        updateCart();
        document.getElementById("result").innerHTML = "";
        lastResult = {};
        document.getElementById("export-btn").classList.add("hidden");
      };

      window.calculate = function calculate() {
        const totalNuts = {};
        let totalWeight = 0;
        let totalPackages = 0;
        let totalCost = 0;
        let materialCostTotal = 0;
        let printingCostTotal = 0;
        let packagingCostTotal = 0;

        let packageDetails = {};
        let showCost = document.getElementById("show-cost").checked;

        cart.forEach((item) => {
          const nutPercentages = nutsData[item.combination];
          totalPackages += item.packageCount;
          totalWeight += item.weightPerPackage * item.packageCount;

          // 记录每种重量的包数
          if (!packageDetails[item.weightPerPackage]) {
            packageDetails[item.weightPerPackage] = 0;
          }
          packageDetails[item.weightPerPackage] += item.packageCount;

          for (const nut in nutPercentages) {
            const percentage = nutPercentages[nut] / 100;
            const nutWeight =
              percentage * item.weightPerPackage * item.packageCount;
            if (!totalNuts[nut]) {
              totalNuts[nut] = 0;
            }
            totalNuts[nut] += nutWeight;
          }

          if (showCost) {
            const cost = calculateCost(
              item.combination,
              item.weightPerPackage,
              item.packageCount
            );
            materialCostTotal += cost.materialCost * item.packageCount;
            printingCostTotal += cost.printing * item.packageCount;
            packagingCostTotal += cost.packaging * item.packageCount;

            totalCost += cost.totalCost;
          }
        });

        lastResult = {
          totalNuts,
          totalWeight,
          totalPackages,
          totalCost,
          packageDetails,
          showCost,
          materialCostTotal,
          printingCostTotal,
          packagingCostTotal,

        };

        displayResult(
          totalNuts,
          totalWeight,
          totalPackages,
          totalCost,
          packageDetails,
          showCost
        );

        // 顯示匯出按鈕
        if (totalPackages > 0) {
          document.getElementById("export-btn").classList.remove("hidden");
        }
      };

      window.displayResult = function displayResult(
        totalNuts,
        totalWeight,
        totalPackages,
        totalCost,
        packageDetails,
        showCost
      ) {
        const resultDiv = document.getElementById("result");
        const extraPercentInput = document.getElementById("extra-percent");
        const extraPercent = parseFloat(extraPercentInput.value) || 0;

        resultDiv.innerHTML = '<ul class="list-disc list-inside">';
        for (const nut in totalNuts) {
          if (totalNuts[nut] > 0) {
            const totalWeightGrams = Math.round(totalNuts[nut]);
            const kg = totalWeightGrams / 1000;
            const extraKg = Math.ceil(kg * (1 + extraPercent / 100));
            const percentAdded = ((extraKg - kg) / kg) * 100;

            resultDiv.innerHTML += `<li>${nut}: ${kg.toFixed(
              2
            )} 公斤 / ${extraKg}公斤 (+${percentAdded.toFixed(2)}%)</li>`;
          }
        }
        resultDiv.innerHTML += "</ul>";

        let packageDetailsText = Object.keys(packageDetails)
          .map((weight) => `${weight}g x ${packageDetails[weight]}包`)
          .join(", ");

        const totalWeightWithExtra = totalWeight * (1 + extraPercent / 100);
        const extraMultiplier = 1 + extraPercent / 100;
        const materialCostTotal = lastResult.materialCostTotal || 0;
        const printingCostTotal = lastResult.printingCostTotal || 0;
        const packagingCostTotal = lastResult.packagingCostTotal || 0;

        const totalCostWithExtra = showCost
          ? materialCostTotal * extraMultiplier + printingCostTotal + packagingCostTotal
          : 0;



        resultDiv.innerHTML += `<p class="mt-10">總包數: ${totalPackages} (${packageDetailsText})</p>`;
        resultDiv.innerHTML += `<p>總重量: ${(
          totalWeightWithExtra / 1000
        ).toFixed(2)} 公斤</p>`;

        if (showCost) {
          const extraMultiplier = 1 + extraPercent / 100;
          const materialCostTotal = lastResult.materialCostTotal || 0;
          const printingCostTotal = lastResult.printingCostTotal || 0;
          const packagingCostTotal = lastResult.packagingCostTotal || 0;

          const costNote = `（原料：$${(
            materialCostTotal * extraMultiplier
          ).toFixed(2)}, 印刷：$${printingCostTotal.toFixed(
            2
          )}, 包裝：$${packagingCostTotal.toFixed(2)}）`;

          resultDiv.innerHTML += `<p>總成本: $${totalCostWithExtra.toFixed(
            2
          )}${costNote}</p>`;
          resultDiv.innerHTML += `<p>每包平均成本: $${(
            totalCostWithExtra / totalPackages
          ).toFixed(2)}</p>`;
        }
      };

      window.exportToTxt = function exportToTxt() {
        let output = "";

        const extraPercentInput = document.getElementById("extra-percent");
        const extraPercent = parseFloat(extraPercentInput.value) || 0;

        output += "小計:\n";
        cart.forEach((item) => {
          let line = `${item.weightPerPackage}g ${item.combination} - ${item.packageCount} 包`;

          const nutPercentages = nutsData[item.combination];
          let nutDetails = "成份：";
          for (const nut in nutPercentages) {
            if (nutPercentages[nut] > 0) {
              nutDetails += `${nut}${nutPercentages[nut]}%、`;
            }
          }
          nutDetails = nutDetails.slice(0, -1);
          line += `\n${nutDetails}`;

          if (document.getElementById("show-cost").checked) {
            const cost = calculateCost(
              item.combination,
              item.weightPerPackage,
              item.packageCount
            );
            if (cost) {
              const costLine = `原料成本: $${cost.materialCost.toFixed(
                2
              )}, 印刷: $${cost.printing.toFixed(
                2
              )}, 包裝: $${cost.packaging.toFixed(
                2
              )}, 總每包: $${cost.totalPerPackage.toFixed(2)}`;
              line += `\n${costLine}`;
            }
          }

          output += line + "\n";
        });

        output += "\n總計:\n";
        for (const nut in lastResult.totalNuts) {
          if (lastResult.totalNuts[nut] > 0) {
            const totalWeightGrams = Math.round(lastResult.totalNuts[nut]);
            const kg = totalWeightGrams / 1000;
            const extraKg = Math.ceil(kg * (1 + extraPercent / 100));
            const percentAdded = ((extraKg - kg) / kg) * 100;

            output += `${nut}: ${kg.toFixed(
              2
            )} 公斤 / ${extraKg}公斤 (+${percentAdded.toFixed(2)}%)\n`;
          }
        }

        let packageDetailsText = Object.keys(lastResult.packageDetails)
          .map(
            (weight) => `${weight}g x ${lastResult.packageDetails[weight]}包`
          )
          .join(", ");

        output += `\n總包數: ${lastResult.totalPackages} (${packageDetailsText})\n`;

        const totalWeightWithExtra =
          lastResult.totalWeight * (1 + extraPercent / 100);
        const totalCostWithExtra = lastResult.showCost
          ? lastResult.totalCost * (1 + extraPercent / 100)
          : 0;

        output += `總重量: ${(totalWeightWithExtra / 1000).toFixed(2)} 公斤\n`;

        if (lastResult.showCost) {
          output += `總成本: $${lastResult.totalCost.toFixed(2)}\n`;
          output += `每包平均成本: $${(
            lastResult.totalCost / lastResult.totalPackages
          ).toFixed(2)}\n`;
          output += `每克平均成本: $${(
            lastResult.totalCost / lastResult.totalWeight
          ).toFixed(4)}\n`;
        }

        const blob = new Blob([output], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "nuts_calculation.txt";
        link.click();
      };

      // 顯示彈窗
      window.showNutRatios = function showNutRatios() {
        document.getElementById("customAlert").style.display = "flex";
      };

      // 關閉彈窗
      window.closeCustomAlert = function closeCustomAlert() {
        document.getElementById("customAlert").style.display = "none";
      };

      window.showNutCosts = function showNutCosts() {
        document.getElementById("costAlert").style.display = "flex";
      };

      window.closeCostAlert = function closeCostAlert() {
        document.getElementById("costAlert").style.display = "none";
      };

      function renderSavedRecords() {
        const recordList = document.getElementById("record-list");
        recordList.innerHTML = "";

        const saved = JSON.parse(localStorage.getItem("savedCarts") || "[]");

        saved.forEach((record, index) => {
          const li = document.createElement("li");
          li.className =
            "flex justify-between items-center bg-gray-100 p-2 rounded";

          const text = document.createElement("span");
          text.textContent = `${record.timestamp} - ${record.cart.length}筆項目`;

          const buttonGroup = document.createElement("div");
          buttonGroup.className = "flex gap-2";

          const loadBtn = document.createElement("button");
          loadBtn.textContent = "載入";
          loadBtn.className =
            "btn-add text-white text-sm font-bold py-1 px-2 rounded";
          loadBtn.onclick = () => {
            cart = record.cart;
            updateCart();
          };

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "刪除";
          deleteBtn.className =
            "btn-reset text-white text-sm font-bold py-1 px-2 rounded";
          deleteBtn.onclick = () => {
            deleteSavedRecord(index);
          };

          buttonGroup.appendChild(loadBtn);
          buttonGroup.appendChild(deleteBtn);
          li.appendChild(text);
          li.appendChild(buttonGroup);
          recordList.appendChild(li);
        });
      }

      window.saveCurrentCart = function saveCurrentCart() {
        if (cart.length === 0) return;

        const saved = JSON.parse(localStorage.getItem("savedCarts") || "[]");
        const timestamp = new Date().toLocaleString("zh-TW");
        const newRecord = { timestamp, cart: [...cart] };

        saved.unshift(newRecord);
        if (saved.length > 5) saved.pop();

        localStorage.setItem("savedCarts", JSON.stringify(saved));
        renderSavedRecords();
      };

      window.deleteSavedRecord = function deleteSavedRecord(index) {
        const saved = JSON.parse(localStorage.getItem("savedCarts") || "[]");
        saved.splice(index, 1);
        localStorage.setItem("savedCarts", JSON.stringify(saved));
        renderSavedRecords();
      };

      window.clearAllSavedRecords = function clearAllSavedRecords() {
        if (confirm("確定要清空所有過往紀錄嗎？")) {
          localStorage.removeItem("savedCarts");
          renderSavedRecords();
        }
      };

      window.moveItem = function moveItem(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= cart.length) return;

        // swap
        const temp = cart[newIndex];
        cart[newIndex] = cart[index];
        cart[index] = temp;

        updateCart();
      };

      // --------- windows 開頭函示結尾 --------- //

      const urlParams = new URLSearchParams(window.location.search);
      const authParam = urlParams.get("auth");

      if (authParam) {
        localStorage.setItem("auth", authParam);
      }

      const authValue = localStorage.getItem("auth");

      if (authValue === "1") {
        document.getElementById("show-cost-label").style.display = "block";
      } else {
        document.getElementById("show-cost-label").style.display = "none";
      }
    </script>
  </body>
</html>
